<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/> 
  <title>Veem Payment Agent - GPT Style</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f7f7f8;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Login Page */
    .login-page {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 48px 40px;
      max-width: 450px;
      width: 100%;
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-header h1 {
      font-size: 28px;
      background: linear-gradient(135deg, #20AAE9 0%, #FF6B35 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .login-header p {
      color: #6e6e80;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #202123;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
      background: white;
    }

    .form-group input:focus {
      outline: none;
      border-color: #20AAE9;
    }

    .login-button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #20AAE9 0%, #FF6B35 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .login-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(255, 107, 53, 0.4);
    }

    .login-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      font-size: 13px;
    }

    .error-message.show {
      display: block;
    }

    /* Chat Page */
    .chat-page {
      display: none;
      flex-direction: column;
      height: 100vh;
    }

    .chat-page.active {
      display: flex;
    }

    /* Header */
    .header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 12px 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #202123;
    }

    /* Chat Container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
    }

    /* Messages */
    .message {
      margin-bottom: 24px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #20AAE9 0%, #0052CC 100%);
    }

    .message.assistant .message-avatar {
      background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);
    }

    .message.system .message-avatar {
      background: #6b7280;
    }

    .message-role {
      font-size: 13px;
      font-weight: 600;
      color: #202123;
    }

    .message-content {
      padding-left: 36px;
      color: #374151;
      line-height: 1.7;
      font-size: 15px;
    }

    .message-content p {
      margin: 0.5em 0;
    }

    .message-content ul,
    .message-content ol {
      margin: 0.5em 0 0.5em 1.5em;
    }

    .message-content li {
      margin: 0.25em 0;
    }

    .message-content code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
    }

    .message-content pre {
      background: #282c34;
      color: #abb2bf;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 12px 0;
      position: relative;
    }

    .message-content pre code {
      background: none;
      padding: 0;
      color: inherit;
      font-size: 13px;
    }

    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .copy-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Input Container */
    .input-container {
      border-top: 1px solid #e5e7eb;
      background: white;
      padding: 16px 20px;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
    }

    .file-upload-area {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f3f4f6;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .file-name {
      flex: 1;
      font-size: 13px;
      color: #6b7280;
    }

    .clear-file-btn {
      padding: 4px 8px;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      color: #374151;
    }

    .message-input-row {
      display: flex;
      gap: 8px;
      align-items: center;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      padding: 8px 12px;
      transition: border-color 0.2s;
    }

    .message-input-row:focus-within {
      border-color: #20AAE9;
    }

    #messageInput {
      flex: 1;
      border: none;
      outline: none;
      font-size: 15px;
      padding: 8px;
      resize: none;
      max-height: 200px;
      font-family: inherit;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-upload-btn {
      padding: 8px 12px;
      background: transparent;
      color: #6b7280;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .file-upload-btn:hover {
      background: #f3f4f6;
      color: #374151;
    }

    #sendButton {
      padding: 8px 16px;
      background: linear-gradient(135deg, #20AAE9 0%, #FF6B35 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #sendButton:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
    }

    #sendButton:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Typing Indicator */
    .typing-indicator {
      display: none;
      padding: 16px 0;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
      padding-left: 36px;
    }

    .typing-indicator.active {
      display: block;
    }

    .typing-dots {
      display: inline-flex;
      gap: 4px;
    }

    .typing-dots span {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #9ca3af;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-8px); }
    }

    .hidden {
      display: none !important;
    }

    /* Scrollbar */
    .chat-container::-webkit-scrollbar {
      width: 8px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 4px;
    }

    .chat-container::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="login-page" id="loginPage">
    <div class="login-container">
      <div class="login-header">
        <h1>Veem Payment Agent</h1>
        <p>Connect securely with your OAuth credentials</p>
      </div>

      <div class="error-message" id="loginError"></div>

      <form id="loginForm">
        <div class="form-group">
          <label for="clientIdInput">Client ID</label>
          <input type="text" id="clientIdInput" placeholder="Enter your client ID" value="XSSupply1-574c4a05" required>
        </div>

        <div class="form-group">
          <label for="clientSecretInput">Client Secret</label>
          <input type="password" id="clientSecretInput" placeholder="Enter your client secret" value="7df113e7-415b-44e3-ab78-409aaec232f6" required>
        </div>

        <button type="submit" class="login-button" id="loginButton">
          Connect to Chat
        </button>
      </form>
    </div>
  </div>

  <!-- Chat Page -->
  <div class="chat-page" id="chatPage">
    <div class="header">
      <h1>Veem Payment Agent</h1>
    </div>

    <div class="chat-container" id="chatContainer">
    </div>

    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>

    <div class="input-container">
      <div class="file-upload-area" id="fileUploadArea">
        <span class="file-name" id="fileName">No file selected</span>
        <button class="clear-file-btn" id="clearFileBtn" onclick="clearFile()">Clear</button>
      </div>
      
      <div class="message-input-row">
        <input type="text" id="messageInput" placeholder="Message Veem Payment Agent...">
        <div class="file-input-wrapper">
          <label for="fileInput" class="file-upload-btn">
            ðŸ“Ž
          </label>
          <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg" onchange="handleFileSelect(event)">
        </div>
        <button id="sendButton">Send</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>

  <script>
    let ws = null;
    let sessionId = null;
    let accountId = null;
    let selectedFile = null;

    const loginPage = document.getElementById('loginPage');
    const chatPage = document.getElementById('chatPage');
    const loginForm = document.getElementById('loginForm');
    const loginButton = document.getElementById('loginButton');
    const loginError = document.getElementById('loginError');
    
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const fileInput = document.getElementById('fileInput');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileName = document.getElementById('fileName');

    const clientIdInput = document.getElementById('clientIdInput');
    const clientSecretInput = document.getElementById('clientSecretInput');

    marked.setOptions({ gfm: true, breaks: true, headerIds: false, mangle: false });

    function looksLikeJSON(str) {
      const s = (str || '').trim();
      return (s.startsWith('{') && s.endsWith('}')) || (s.startsWith('[') && s.endsWith(']'));
    }

    function renderContentToHTML(content) {
      let raw = typeof content === 'string' ? content : (() => {
        try { return JSON.stringify(content, null, 2); } catch { return String(content); }
      })();

      if (looksLikeJSON(raw) && !raw.includes('```')) {
        const pretty = (() => { try { return JSON.stringify(JSON.parse(raw), null, 2); } catch { return raw; }})();
        raw = "```json\n" + pretty + "\n```";
      }

      const html = marked.parse(raw);
      return DOMPurify.sanitize(html, { USE_PROFILES: { html: true } });
    }

    function enhanceCodeBlocks(container) {
      container.querySelectorAll('pre > code').forEach((codeEl) => {
        try { hljs.highlightElement(codeEl); } catch {}
        const pre = codeEl.parentElement;
        pre.style.position = 'relative';
        const btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'Copy';
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(codeEl.innerText);
            btn.textContent = 'Copied';
            setTimeout(() => (btn.textContent = 'Copy'), 1200);
          } catch {}
        });
        pre.appendChild(btn);
      });
    }

    function showError(message) {
      loginError.textContent = message;
      loginError.classList.add('show');
      setTimeout(() => loginError.classList.remove('show'), 5000);
    }

    function generateSessionId() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        selectedFile = file;
        fileName.textContent = file.name;
        fileUploadArea.style.display = 'flex';
      }
    }

    function clearFile() {
      selectedFile = null;
      fileInput.value = '';
      fileName.textContent = 'No file selected';
      fileUploadArea.style.display = 'none';
    }

    async function uploadDocument() {
      if (!selectedFile) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64Data = e.target.result.split(',')[1];
        
        addMessage('user', `ðŸ“Ž Uploading: ${selectedFile.name}`);
        
        ws.send(JSON.stringify({
          type: 'document_upload',
          document_data: base64Data,
          filename: selectedFile.name
        }));
        
        clearFile();
      };
      reader.readAsDataURL(selectedFile);
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const clientId = clientIdInput.value.trim();
      const clientSecret = clientSecretInput.value.trim();
      
      if (!clientId || !clientSecret) {
        showError('Please enter both Client ID and Client Secret');
        return;
      }

      loginButton.disabled = true;
      loginButton.textContent = 'Connecting...';

      try {
        sessionId = generateSessionId();
        const wsUrl = `ws://localhost:8000/ws/${sessionId}?client_id=${encodeURIComponent(clientId)}&client_secret=${encodeURIComponent(clientSecret)}`;
        
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log('WebSocket connected');
          loginPage.classList.add('hidden');
          chatPage.classList.add('active');
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleMessage(data);
          } catch (err) {
            console.error('Error parsing message:', err);
          }
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          showError('Connection error. Please check your credentials and try again.');
          loginButton.disabled = false;
          loginButton.textContent = 'Connect to Chat';
        };

        ws.onclose = () => {
          console.log('WebSocket disconnected');
        };

      } catch (error) {
        console.error('Connection error:', error);
        showError('Failed to connect. Please try again.');
        loginButton.disabled = false;
        loginButton.textContent = 'Connect to Chat';
      }
    });

    function handleMessage(data) {
      typingIndicator.classList.remove('active');

      if (data.type === 'welcome') {
        accountId = data.account_id;
        addMessage('system', data.message);
      } else if (data.type === 'response') {
        addMessage('assistant', data.content);
      } else if (data.type === 'document_uploaded') {
        addMessage('system', data.message);
        addMessage('assistant', data.extracted_details);
      } else if (data.type === 'status') {
        if (data.status === 'processing') {
          typingIndicator.classList.add('active');
        }
      } else if (data.type === 'error') {
        addMessage('system', `Error: ${data.message || data.error || 'Unknown error'}`);
      }
    }

    function addMessage(role, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;

      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';

      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'message-avatar';
      avatarDiv.textContent = role === 'user' ? 'ðŸ‘¤' : role === 'assistant' ? 'ðŸ¤–' : 'â„¹ï¸';

      const roleDiv = document.createElement('div');
      roleDiv.className = 'message-role';
      roleDiv.textContent = role === 'user' ? 'You' : role === 'assistant' ? 'Veem Agent' : 'System';

      headerDiv.appendChild(avatarDiv);
      headerDiv.appendChild(roleDiv);

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = renderContentToHTML(content);

      messageDiv.appendChild(headerDiv);
      messageDiv.appendChild(contentDiv);
      chatContainer.appendChild(messageDiv);

      enhanceCodeBlocks(contentDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function sendMessage() {
      if (selectedFile) {
        uploadDocument();
        return;
      }

      const message = messageInput.value.trim();
      if (!message || !ws || ws.readyState !== WebSocket.OPEN) return;

      addMessage('user', message);
      
      ws.send(JSON.stringify({
        type: 'message',
        content: message
      }));

      messageInput.value = '';
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
